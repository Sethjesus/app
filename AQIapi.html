<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ç’°å¢ƒç›£æ§ - æ‰‹æ©Ÿç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS æ¨£å¼ä¿æŒä¸è®Š */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        html, body { width: 100%; height: 100%; overflow-x: hidden; -webkit-text-size-adjust: 100%; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; }
        .container { width: 100%; max-width: 100%; margin: 0 auto; padding: 15px; padding-bottom: 80px; }
        .status-bar { background: rgba(255,255,255,0.15); border-radius: 15px; padding: 15px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ff4757; }
        .status-dot.connected { background: #2ed573; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        .data-cards { display: flex; flex-direction: column; gap: 15px; }
        .data-card { background: rgba(255,255,255,0.12); border-radius: 20px; padding: 20px; }
        .value { font-size: 3.5rem; font-weight: 800; }
        .chart-container { height: 250px; margin-top: 20px; }
        .bottom-controls { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.9); padding: 12px 15px; display: flex; gap: 10px; overflow-x: auto; }
        .control-btn { background: rgba(255,255,255,0.15); border: none; border-radius: 12px; padding: 14px 18px; color: white; display: flex; flex-direction: column; align-items: center; gap: 6px; min-width: 80px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot" id="statusDot"></span>
                <span id="connectionStatus">é€£ç·šä¸­...</span>
            </div>
            <div class="status-item">
                <span>ğŸ•’</span>
                <span id="lastUpdate">--:--</span>
            </div>
        </div>
        
        <div class="data-cards">
            <div class="data-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">ğŸŒ«ï¸</span>
                        COâ‚‚ æ¿ƒåº¦
                    </div>
                    <span>ppm</span>
                </div>
                <div class="value-display">
                    <div class="value" id="co2Value">--</div>
                    <div class="quality-badge" id="co2Quality">--</div>
                </div>
                <div class="chart-container">
                    <canvas id="co2Chart"></canvas>
                </div>
            </div>
            
            <div class="data-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">ğŸ’¨</span>
                        PM2.5 æ¿ƒåº¦
                    </div>
                    <span>Î¼g/mÂ³</span>
                </div>
                <div class="value-display">
                    <div class="value" id="pm25Value">--</div>
                    <div class="quality-badge" id="pm25Quality">--</div>
                </div>
                <div class="chart-container">
                    <canvas id="pm25Chart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bottom-controls">
        <button class="control-btn" onclick="refreshData()">
            <span class="btn-icon">ğŸ”„</span>
            <span class="btn-label">æ›´æ–°</span>
        </button>
        <button class="control-btn" onclick="showHistory()">
            <span class="btn-icon">ğŸ“Š</span>
            <span class="btn-label">æ­·å²</span>
        </button>
        <button class="control-btn" onclick="exportData()">
            <span class="btn-icon">ğŸ“¥</span>
            <span class="btn-label">åŒ¯å‡º</span>
        </button>
    </div>

    <script>
        // ============ é‡è¦è¨­å®š ============
        // ä½ çš„é›»è…¦ IP åœ°å€
        const API_BASE_URL = 'http://192.168.0.179:5000';
        
        console.log('ğŸ“± ç’°å¢ƒç›£æ§æ‰‹æ©Ÿç‰ˆ');
        console.log('ğŸ“¡ API ä¼ºæœå™¨:', API_BASE_URL);
        
        // å…¨åŸŸè®Šæ•¸
        let co2Chart = null;
        let pm25Chart = null;
        let chartData = { labels: [], co2: [], pm25: [] };
        
        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç³»çµ±åˆå§‹åŒ–...');
            
            // æ¸¬è©¦é€£ç·š
            testConnection();
            
            // åˆå§‹åŒ–åœ–è¡¨
            initCharts();
            
            // é–‹å§‹è‡ªå‹•æ›´æ–°
            setInterval(loadData, 30000);
            
            // ç«‹å³è¼‰å…¥ä¸€æ¬¡è³‡æ–™
            loadData();
        });
        
        // ============ é€£ç·šæ¸¬è©¦ ============
        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                if (response.ok) {
                    updateConnectionStatus('connected');
                    showMessage('âœ… API é€£ç·šæˆåŠŸ');
                }
            } catch (error) {
                console.error('é€£ç·šå¤±æ•—:', error);
                updateConnectionStatus('disconnected');
                showMessage('âŒ ç„¡æ³•é€£ç·šåˆ° API');
            }
        }
        
        // ============ è³‡æ–™è¼‰å…¥ ============
        async function loadData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/data/latest`);
                if (!response.ok) throw new Error('API éŒ¯èª¤');
                
                const data = await response.json();
                updateDisplay(data);
                updateCharts(data);
                updateConnectionStatus('connected');
                
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                updateConnectionStatus('disconnected');
            }
        }
        
        function updateDisplay(data) {
            document.getElementById('co2Value').textContent = data.co2.toFixed(1);
            document.getElementById('pm25Value').textContent = data.pm25.toFixed(2);
            
            const time = new Date(data.timestamp);
            const timeStr = time.getHours().toString().padStart(2, '0') + ':' + 
                           time.getMinutes().toString().padStart(2, '0');
            document.getElementById('lastUpdate').textContent = timeStr;
        }
        
        // ============ åœ–è¡¨åŠŸèƒ½ ============
        function initCharts() {
            const co2Ctx = document.getElementById('co2Chart').getContext('2d');
            const pm25Ctx = document.getElementById('pm25Chart').getContext('2d');
            
            co2Chart = new Chart(co2Ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'COâ‚‚',
                        data: chartData.co2,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52,152,219,0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
            
            pm25Chart = new Chart(pm25Ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'PM2.5',
                        data: chartData.pm25,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231,76,60,0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function updateCharts(data) {
            const now = new Date();
            const timeLabel = now.getHours().toString().padStart(2, '0') + ':' + 
                             now.getMinutes().toString().padStart(2, '0');
            
            // é™åˆ¶è³‡æ–™é»æ•¸é‡
            const maxPoints = 20;
            
            chartData.labels.push(timeLabel);
            chartData.co2.push(data.co2);
            chartData.pm25.push(data.pm25);
            
            if (chartData.labels.length > maxPoints) {
                chartData.labels.shift();
                chartData.co2.shift();
                chartData.pm25.shift();
            }
            
            co2Chart.data.labels = chartData.labels;
            co2Chart.data.datasets[0].data = chartData.co2;
            co2Chart.update('none');
            
            pm25Chart.data.labels = chartData.labels;
            pm25Chart.data.datasets[0].data = chartData.pm25;
            pm25Chart.update('none');
        }
        
        // ============ å·¥å…·å‡½æ•¸ ============
        function refreshData() {
            loadData();
            showMessage('ğŸ”„ æ›´æ–°ä¸­...');
        }
        
        function updateConnectionStatus(status) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('connectionStatus');
            
            if (status === 'connected') {
                dot.className = 'status-dot connected';
                text.textContent = 'å·²é€£ç·š';
            } else {
                dot.className = 'status-dot';
                text.textContent = 'é›¢ç·š';
            }
        }
        
        function showMessage(msg) {
            // ç°¡å–®çš„è¨Šæ¯é¡¯ç¤º
            console.log(msg);
        }
        
        function showHistory() {
            alert('æ­·å²è³‡æ–™åŠŸèƒ½');
        }
        
        function exportData() {
            alert('åŒ¯å‡ºåŠŸèƒ½');
        }
        
        // æ‰‹æ©Ÿéœ‡å‹•
        function vibrate() {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
    </script>
</body>
</html>